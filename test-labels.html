<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Labels - Kalendarz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #5568d3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e8f5e9;
            border: 1px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            border-color: #f44336;
        }
        .label-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .label-chip {
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üè∑Ô∏è Test Labels System</h1>

    <div class="test-container">
        <h2>Test 1: Initialize Labels</h2>
        <button onclick="testInitLabels()">Run Test</button>
        <div id="test1Result"></div>
    </div>

    <div class="test-container">
        <h2>Test 2: Add New Label</h2>
        <button onclick="testAddLabel()">Run Test</button>
        <div id="test2Result"></div>
    </div>

    <div class="test-container">
        <h2>Test 3: Save and Load State</h2>
        <button onclick="testSaveLoadState()">Run Test</button>
        <div id="test3Result"></div>
    </div>

    <div class="test-container">
        <h2>Test 4: Activate Label</h2>
        <button onclick="testActivateLabel()">Run Test</button>
        <div id="test4Result"></div>
    </div>

    <div class="test-container">
        <h2>Current Labels</h2>
        <button onclick="displayCurrentLabels()">Show Labels</button>
        <div id="currentLabelsDisplay"></div>
    </div>

    <div class="test-container">
        <h2>Clear Storage</h2>
        <button onclick="clearStorage()" style="background: #f44336;">Clear localStorage</button>
        <div id="clearResult"></div>
    </div>

    <script>
        // Mock minimal environment for testing
        window.APP_CONFIG = {
            defaultSaturdayMode: 'NOT_COMPENSATED',
            consentRequired: false,
            analytics: { provider: 'none' },
            ads: { enabled: false }
        };
        window.SAT_MODE = {
            COMPENSATED: 'COMPENSATED',
            NOT_COMPENSATED: 'NOT_COMPENSATED'
        };

        // Helper function to display results
        function showResult(elementId, success, message, data = null) {
            const el = document.getElementById(elementId);
            const statusClass = success ? '' : 'error';
            let html = `<div class="status ${statusClass}">${message}</div>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            el.innerHTML = html;
        }

        // Test 1: Initialize Labels
        function testInitLabels() {
            try {
                // Clear any existing data
                delete window.labels;
                delete window.labeledDays;
                
                // Initialize
                initLabels();
                
                // Verify
                if (!window.labels) {
                    throw new Error('window.labels is not defined');
                }
                if (!Array.isArray(window.labels)) {
                    throw new Error('window.labels is not an array');
                }
                if (window.labels.length !== 3) {
                    throw new Error(`Expected 3 default labels, got ${window.labels.length}`);
                }
                if (!window.labeledDays || typeof window.labeledDays !== 'object') {
                    throw new Error('window.labeledDays is not properly initialized');
                }
                
                showResult('test1Result', true, 
                    '‚úì Labels initialized successfully!', 
                    { labels: window.labels, labeledDays: window.labeledDays });
            } catch (error) {
                showResult('test1Result', false, 
                    `‚úó Test failed: ${error.message}`);
            }
        }

        // Test 2: Add New Label
        function testAddLabel() {
            try {
                // Initialize if not already
                if (!window.labels) {
                    initLabels();
                }
                
                const initialCount = window.labels.length;
                
                // Mock prompt to avoid user interaction
                const originalPrompt = window.prompt;
                window.prompt = () => 'Test Label';
                
                // Add label
                addNewLabel();
                
                // Restore prompt
                window.prompt = originalPrompt;
                
                // Verify
                if (window.labels.length !== initialCount + 1) {
                    throw new Error(`Expected ${initialCount + 1} labels, got ${window.labels.length}`);
                }
                
                const newLabel = window.labels[window.labels.length - 1];
                if (newLabel.name !== 'Test Label') {
                    throw new Error(`Expected label name 'Test Label', got '${newLabel.name}'`);
                }
                if (!newLabel.id || !newLabel.id.startsWith('label_')) {
                    throw new Error(`Invalid label ID: ${newLabel.id}`);
                }
                if (!newLabel.color || !newLabel.color.startsWith('#')) {
                    throw new Error(`Invalid label color: ${newLabel.color}`);
                }
                
                showResult('test2Result', true, 
                    '‚úì Label added successfully!', 
                    { newLabel, totalLabels: window.labels.length });
            } catch (error) {
                showResult('test2Result', false, 
                    `‚úó Test failed: ${error.message}`);
            }
        }

        // Test 3: Save and Load State
        function testSaveLoadState() {
            try {
                // Initialize if not already
                if (!window.labels) {
                    initLabels();
                }
                
                // Mock DOM elements needed for saveState
                if (!document.getElementById('yearSelect')) {
                    const select = document.createElement('select');
                    select.id = 'yearSelect';
                    const option = document.createElement('option');
                    option.value = '2025';
                    option.selected = true;
                    select.appendChild(option);
                    document.body.appendChild(select);
                }
                
                // Mock satMode radios
                if (!document.querySelector('input[name="satMode"]')) {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'satMode';
                    radio.value = 'NOT_COMPENSATED';
                    radio.checked = true;
                    document.body.appendChild(radio);
                }
                
                // Add a test label
                window.labels.push({
                    id: 'test_label_123',
                    name: 'Test Label for Save',
                    color: '#ff0000',
                    active: false
                });
                
                // Save state
                saveState();
                
                // Load state
                const loadedState = loadState();
                
                // Verify
                if (!loadedState) {
                    throw new Error('Failed to load state from localStorage');
                }
                if (!loadedState.labels) {
                    throw new Error('Labels not saved in state');
                }
                if (!Array.isArray(loadedState.labels)) {
                    throw new Error('Saved labels is not an array');
                }
                
                const testLabel = loadedState.labels.find(l => l.id === 'test_label_123');
                if (!testLabel) {
                    throw new Error('Test label not found in saved state');
                }
                if (testLabel.name !== 'Test Label for Save') {
                    throw new Error('Label name mismatch in saved state');
                }
                
                showResult('test3Result', true, 
                    '‚úì State saved and loaded successfully!', 
                    { savedState: loadedState });
            } catch (error) {
                showResult('test3Result', false, 
                    `‚úó Test failed: ${error.message}`);
            }
        }

        // Test 4: Activate Label
        function testActivateLabel() {
            try {
                // Initialize if not already
                if (!window.labels) {
                    initLabels();
                }
                
                // Deactivate all
                window.labels.forEach(l => l.active = false);
                
                // Activate first label
                window.labels[0].active = true;
                
                // Get active label
                const activeLabel = getActiveLabel();
                
                // Verify
                if (!activeLabel) {
                    throw new Error('No active label found');
                }
                if (activeLabel.id !== window.labels[0].id) {
                    throw new Error('Wrong label is active');
                }
                
                showResult('test4Result', true, 
                    '‚úì Label activated successfully!', 
                    { activeLabel });
            } catch (error) {
                showResult('test4Result', false, 
                    `‚úó Test failed: ${error.message}`);
            }
        }

        // Display current labels
        function displayCurrentLabels() {
            const el = document.getElementById('currentLabelsDisplay');
            if (!window.labels || window.labels.length === 0) {
                el.innerHTML = '<div class="status error">No labels found. Run "Initialize Labels" test first.</div>';
                return;
            }
            
            let html = '<div class="status">Current labels in memory:</div>';
            window.labels.forEach((label, index) => {
                html += `
                    <div class="label-item">
                        <span>${index + 1}.</span>
                        <span class="label-chip" style="background-color: ${label.color}">
                            ${label.name}
                        </span>
                        <span>ID: ${label.id}</span>
                        <span>${label.active ? '‚úì Active' : ''}</span>
                    </div>
                `;
            });
            el.innerHTML = html;
        }

        // Clear localStorage
        function clearStorage() {
            try {
                localStorage.removeItem('kalendarz-pl:v1');
                showResult('clearResult', true, '‚úì localStorage cleared successfully!');
            } catch (error) {
                showResult('clearResult', false, `‚úó Failed: ${error.message}`);
            }
        }
    </script>

    <!-- Load the actual app.js functions we want to test -->
    <script src="app.js"></script>
</body>
</html>
