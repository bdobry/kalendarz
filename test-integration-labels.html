<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Labels</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        pre { background: white; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Integration Test - Label System</h1>
    <div id="results"></div>

    <script src="../config.js"></script>
    <script src="../app.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(`[${type}] ${message}`);
        }

        function logData(data) {
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(data, null, 2);
            results.appendChild(pre);
        }

        async function runTests() {
            log('Starting integration tests...', 'info');
            
            try {
                // Test 1: Check if functions exist
                log('Test 1: Checking if all required functions exist...', 'info');
                const requiredFunctions = [
                    'getDefaultLabels',
                    'initLabels',
                    'renderLabels',
                    'getActiveLabel',
                    'generateRandomColor',
                    'addNewLabel',
                    'initAddLabelButton',
                    'saveState',
                    'loadState'
                ];
                
                let allExist = true;
                requiredFunctions.forEach(funcName => {
                    if (typeof window[funcName] !== 'function') {
                        log(`✗ Function ${funcName} not found`, 'error');
                        allExist = false;
                    }
                });
                
                if (allExist) {
                    log('✓ All required functions exist', 'success');
                } else {
                    throw new Error('Some functions are missing');
                }

                // Test 2: Initialize labels
                log('Test 2: Initializing labels...', 'info');
                
                // Create mock DOM elements
                const mockElements = {};
                const originalGetElementById = document.getElementById;
                document.getElementById = function(id) {
                    if (id === 'labelsList') {
                        if (!mockElements.labelsList) {
                            mockElements.labelsList = document.createElement('div');
                            mockElements.labelsList.id = 'labelsList';
                        }
                        return mockElements.labelsList;
                    }
                    if (id === 'yearSelect') {
                        if (!mockElements.yearSelect) {
                            const select = document.createElement('select');
                            select.id = 'yearSelect';
                            const option = document.createElement('option');
                            option.value = '2025';
                            option.selected = true;
                            select.appendChild(option);
                            mockElements.yearSelect = select;
                        }
                        return mockElements.yearSelect;
                    }
                    if (id === 'addLabelBtn') {
                        if (!mockElements.addLabelBtn) {
                            const btn = document.createElement('button');
                            btn.id = 'addLabelBtn';
                            mockElements.addLabelBtn = btn;
                        }
                        return mockElements.addLabelBtn;
                    }
                    return originalGetElementById.call(document, id);
                };
                
                // Mock getElementsByName for satMode
                const originalGetElementsByName = document.getElementsByName;
                document.getElementsByName = function(name) {
                    if (name === 'satMode') {
                        if (!mockElements.satModeRadios) {
                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = 'satMode';
                            radio.value = 'NOT_COMPENSATED';
                            radio.checked = true;
                            mockElements.satModeRadios = [radio];
                        }
                        return mockElements.satModeRadios;
                    }
                    return originalGetElementsByName.call(document, name);
                };
                
                initLabels();
                
                if (!window.labels || !Array.isArray(window.labels)) {
                    throw new Error('Labels not initialized properly');
                }
                if (window.labels.length !== 3) {
                    throw new Error(`Expected 3 default labels, got ${window.labels.length}`);
                }
                log(`✓ Labels initialized with ${window.labels.length} default labels`, 'success');
                logData({ defaultLabels: window.labels });

                // Test 3: Generate random color
                log('Test 3: Testing random color generation...', 'info');
                const color1 = generateRandomColor();
                const color2 = generateRandomColor();
                if (!color1 || !color1.startsWith('#')) {
                    throw new Error('Invalid color generated');
                }
                log(`✓ Random colors generated: ${color1}, ${color2}`, 'success');

                // Test 4: Add new label (mock prompt)
                log('Test 4: Testing add new label...', 'info');
                const originalPrompt = window.prompt;
                window.prompt = (message) => {
                    log(`Prompt called with message: "${message}"`, 'info');
                    return 'My Custom Label';
                };
                
                const initialCount = window.labels.length;
                addNewLabel();
                
                window.prompt = originalPrompt;
                
                if (window.labels.length !== initialCount + 1) {
                    throw new Error('Label was not added');
                }
                const newLabel = window.labels[window.labels.length - 1];
                if (newLabel.name !== 'My Custom Label') {
                    throw new Error('Label name is incorrect');
                }
                log(`✓ New label added successfully`, 'success');
                logData({ newLabel });

                // Test 5: Activate label
                log('Test 5: Testing label activation...', 'info');
                window.labels.forEach(l => l.active = false);
                window.labels[0].active = true;
                const activeLabel = getActiveLabel();
                if (!activeLabel || activeLabel.id !== window.labels[0].id) {
                    throw new Error('Label activation failed');
                }
                log(`✓ Label activated: ${activeLabel.name}`, 'success');

                // Test 6: Save and load state
                log('Test 6: Testing state persistence...', 'info');
                localStorage.removeItem('kalendarz-pl:v1');
                
                saveState();
                const savedState = loadState();
                
                if (!savedState) {
                    throw new Error('Failed to save/load state');
                }
                if (!savedState.labels || !Array.isArray(savedState.labels)) {
                    throw new Error('Labels not saved in state');
                }
                if (savedState.labels.length !== window.labels.length) {
                    throw new Error('Not all labels were saved');
                }
                log(`✓ State saved and loaded successfully`, 'success');
                logData({ savedState });

                // Test 7: Initialize add label button
                log('Test 7: Testing add label button initialization...', 'info');
                initAddLabelButton();
                const btn = document.getElementById('addLabelBtn');
                if (!btn) {
                    throw new Error('Add label button not found');
                }
                
                // Check if event listener was attached (we can't directly verify, but we can trigger it)
                log(`✓ Add label button initialized`, 'success');

                // Final summary
                log('═══════════════════════════════════', 'info');
                log('✓ ALL TESTS PASSED!', 'success');
                log('═══════════════════════════════════', 'info');
                
            } catch (error) {
                log(`✗ TEST FAILED: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        // Run tests when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }
    </script>
</body>
</html>
